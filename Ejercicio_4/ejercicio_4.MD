# ğŸ” Troubleshooting BGP - Cisco

Este documento detalla el anÃ¡lisis de las sesiones BGP en la red, identificando diferencias entre conexiones **iBGP** y **eBGP**, ademÃ¡s de estrategias para diagnosticar y solucionar problemas de conectividad con los proveedores de nube (AWS, GCP, Azure).

---

## **ğŸ“Œ 1. Diferencias entre las sesiones BGP**

### **ğŸ”¹ SesiÃ³n #1 (A â†” B, dentro de ASN 65000, Backbone conectado a Proveedores Cloud)**  
âœ… **Tipo:** **iBGP** (Internal BGP)  
âœ… **CaracterÃ­sticas:**  
- Ambos routers pertenecen al mismo **ASN (65000)** del backbone.  
- Conectan el backbone a los proveedores de nube (**AWS, GCP, Azure**) a travÃ©s de la sesiÃ³n **ASN 65003**.  
- No modifican el **Next-Hop** de las rutas anunciadas.  
- Requieren una configuraciÃ³n **full-mesh** o el uso de **Route Reflectors** para la propagaciÃ³n de rutas.  

### **ğŸ”¹ SesiÃ³n #2 (A â†” C, conexiÃ³n entre el Backbone y el Datacenter)**  
âœ… **Tipo:** **eBGP** (External BGP)  
âœ… **CaracterÃ­sticas:**  
- ConexiÃ³n entre **AS distintos** (**65000 â†” 65001**).  
- **El Next-Hop cambia** para garantizar la correcta redistribuciÃ³n de rutas.  
- No requiere full-mesh, ya que cada router solo establece sesiÃ³n con su vecino BGP.  
- Puede aplicar **polÃ­ticas de filtrado** mÃ¡s estrictas, como **MED**, **Local Preference** y filtrado de prefijos.  

### **ğŸ”¹ SesiÃ³n #3 (C â†” D, dentro del Datacenter, ASN 65001)**  
âœ… **Tipo:** **iBGP** (Internal BGP dentro del Datacenter)  
âœ… **CaracterÃ­sticas:**  
- Ambos routers pertenecen a **ASN 65001** dentro del datacenter.  
- No se cambia el **Next-Hop**, lo que requiere configuraciones adicionales para redistribuir rutas.  
- Puede usar **Route Reflectors** si hay mÃºltiples conexiones dentro del datacenter.  

ğŸ“Œ **Diferencia clave:** **Las sesiones dentro de un mismo ASN (iBGP) requieren propagaciÃ³n especial de rutas, mientras que las sesiones entre AS diferentes (eBGP) implican cambios de Next-Hop y aplicaciÃ³n de polÃ­ticas.**

---

## **ğŸ“Œ 2. DiagnÃ³stico de Problemas entre el Backbone y el Cloud Provider**

### **ğŸ” Posibles causas:**
1ï¸âƒ£ **Falta de anuncios de rutas** â†’ El Cloud Provider no estÃ¡ recibiendo las rutas del backbone.  
2ï¸âƒ£ **Filtros de trÃ¡fico en polÃ­ticas BGP** â†’ Puede estar bloqueando prefijos o cambiando atributos crÃ­ticos.  
3ï¸âƒ£ **SesiÃ³n BGP inactiva** â†’ Problemas de configuraciÃ³n o conectividad entre los routers.  
4ï¸âƒ£ **Next-Hop incorrecto** â†’ La red puede estar enviando trÃ¡fico a una IP no accesible.

---

## **ğŸ“Œ 3. Comandos de Troubleshooting en Cisco**

### **1ï¸âƒ£ Verificar el estado de la sesiÃ³n BGP**
```bash
show ip bgp summary
```
ğŸ“Œ **Salida esperada:**  
```
Neighbor        V    AS  MsgRcvd  MsgSent  Up/Down  State/PfxRcd
192.168.1.1     4  65000   1234     5678   10:05:32  100
```
ğŸ” **Si el estado no es `Established`, la sesiÃ³n BGP estÃ¡ caÃ­da.**  

### **2ï¸âƒ£ Verificar las rutas BGP recibidas del Cloud Provider**
```bash
show ip bgp neighbors 192.168.1.1 received-routes
```

### **3ï¸âƒ£ Verificar las rutas que se estÃ¡n anunciando al Cloud Provider**
```bash
show ip bgp neighbors 192.168.1.1 advertised-routes
```

### **4ï¸âƒ£ Comprobar si las rutas estÃ¡n siendo filtradas**
```bash
show ip bgp neighbor 192.168.1.1 route-map
```

### **5ï¸âƒ£ Validar la conectividad con el Cloud Provider**
```bash
ping 192.168.1.1 source Loopback0
```

---

## **ğŸ“Œ 4. Soluciones TÃ©cnicas**

âœ… **1ï¸âƒ£ Si la sesiÃ³n BGP no se establece:**
```bash
router bgp 65000
 neighbor 192.168.1.1 remote-as 65003
```

âœ… **2ï¸âƒ£ Si no hay anuncios de rutas:**
```bash
router bgp 65000
 network 10.0.0.0 mask 255.255.255.0
```

âœ… **3ï¸âƒ£ Si hay filtros bloqueando anuncios:**
```bash
route-map ALLOW-ALL permit 10
 match ip address prefix-list ALL
```

âœ… **4ï¸âƒ£ Si hay problemas con el Next-Hop:**
```bash
router bgp 65000
 neighbor 192.168.1.1 next-hop-self
```

---

## **ğŸ“Œ 5. Resumen Final**

| Problema                     | Posible Causa                        | Comando de DiagnÃ³stico                  | SoluciÃ³n TÃ©cnica                     |
|------------------------------|-------------------------------------|-----------------------------------------|---------------------------------------|
| SesiÃ³n BGP caÃ­da             | Conectividad, autenticaciÃ³n MD5     | `show ip bgp summary`                   | Revisar conectividad, autenticaciÃ³n   |
| No hay anuncios de rutas     | Cloud Provider no estÃ¡ enviando     | `show ip bgp neighbors received-routes` | Revisar configuraciÃ³n BGP             |
| Rutas no se propagan         | Route maps bloquean anuncios        | `show ip bgp neighbor route-map`        | Modificar o eliminar filtros          |
| Next-Hop no alcanzable       | BGP no cambia el Next-Hop           | `show ip bgp`                           | Configurar `next-hop-self` en iBGP    |

ğŸš€ **Este procedimiento proporciona un enfoque estructurado para diagnosticar y resolver problemas de BGP en una red Cisco que conecta un Backbone con proveedores de nube y un Datacenter.**

